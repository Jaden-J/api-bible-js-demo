<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Bible API Example Application</title>

    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="scripture.css">
  </head>

  <body>
    <div class="container pt-5">
      <h1>Bible API Example Application</h1>
      <span id="breadcrumbs"></span>
      <h2>Selected verse:</h2>
      <span id="verse"></span>
    </div>

    <script src="my_key.js"></script>
    <script>
      const bibleVerseList = document.querySelector(`#verse`);
      const bibleVersionID = getParameterByName(`version`);
      const bibleVerseID = getParameterByName(`verse`);
      const abbreviation = getParameterByName(`abbr`);

      if (!bibleVersionID || !bibleVerseID) {
        window.location.href = `./index.html`;
      }

      getSelectedVerse(bibleVersionID, bibleVerseID).then(({ bibleId, bookId, content }) => {
        getBookNameFromID(bibleId, bookId).then((book) => {
          bibleVerseList.innerHTML = `<span><i>${book} ${bibleVerseID.slice(4)}</i></span><div class="eb-container">${content}</div>`;
        });
      });

      let [book, chapter, verse] = bibleVerseID.split(`.`);
      if (bibleVerseID.includes(`-`)) {
        verse = bibleVerseID.split(`-`).shift().split(`.`).pop() + `-` + bibleVerseID.split(`-`).pop().split(`.`).pop();
      }
      const breadcrumbsHTML = `<a href="index.html">home</a> 
                               > <a href="book.html?version=${bibleVersionID}&abbr=${abbreviation}">${abbreviation}</a>
                               > <a href="chapter.html?version=${bibleVersionID}&abbr=${abbreviation}&book=${book}">${book}</a>
                               > <a href="verse.html?version=${bibleVersionID}&abbr=${abbreviation}&chapter=${book}.${chapter}"> ${chapter} </a>
                               > ${verse}`;
      breadcrumbs.innerHTML = breadcrumbsHTML;

      /**
       * Gets selected verse from API.Bible
       * @param {string} bibleVersionID to get verse from
       * @param {string} bibleVerseID of selected verse
       * @returns {Promise} containing selected verse
       */
      function getSelectedVerse(bibleVersionID, bibleVerseID) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.withCredentials = false;

          xhr.addEventListener(`readystatechange`, function() {
            if (this.readyState === this.DONE) {
              const {content, bookId, bibleId} = JSON.parse(this.responseText).data;
              const verse = {content, bookId, bibleId};

              resolve(verse);
            }
          });

          xhr.open(`GET`, `https://api.scripture.api.bible/v1/bibles/${bibleVersionID}/verses/${bibleVerseID}?include-chapter-numbers=false&include-verse-numbers=false`);
          xhr.setRequestHeader(`api-key`, API_KEY);

          xhr.onerror = () => reject(xhr.statusText);

          xhr.send();
        });
      }

      /**
       * Gets book name from book ID
       * @param {string} bibleVersionID Bible ID
       * @param {string} bibleBookID book ID
       * @returns {string} name of book
       */
      function getBookNameFromID(bibleVersionID, bibleBookID) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.withCredentials = false;

          xhr.addEventListener(`readystatechange`, function() {
            if (this.readyState === this.DONE) {
              const {name} = JSON.parse(this.responseText).data;
              resolve(name);
            }
          });

          xhr.open(`GET`, `https://api.scripture.api.bible/v1/bibles/${bibleVersionID}/books/${bibleBookID}`);
          xhr.setRequestHeader(`api-key`, API_KEY);

          xhr.onerror = () => reject(xhr.statusText);

          xhr.send();
        });
      }

      /**
       * Gets query parameter from URL based on name
       * @param {string} name of query parameter
       * @returns {string} value of query parameter
       */
      function getParameterByName(name) {
        const url = window.location.href;
        name = name.replace(/[\[\]]/g, `\\$&`);
        const regex = new RegExp(`[?&]` + name + `(=([^&#]*)|&|#|$)`),
          results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return ``;
        return decodeURIComponent(results[2].replace(/\+/g, ` `));
      }
    </script>
  </body>

</html>